input {
  # Menerima log JSON dari aplikasi Spring Boot via TCP
  tcp {
    port => 5000
    codec => json
    type => "spring-boot-logs"
  }
}

filter {
  # Parse timestamp dari log
  if [type] == "spring-boot-logs" {
    date {
      match => [ "@timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
      target => "@timestamp"
    }
    
    # Add fingerprint untuk deduplikasi
    fingerprint {
      source => ["message", "@timestamp", "logger_name"]
      target => "[@metadata][fingerprint]"
      method => "SHA256"
    }
    
    # Add tags berdasarkan service name
    if [service] {
      mutate {
        add_tag => [ "service-%{service}" ]
      }
    }
    
    # Add tags berdasarkan log level
    if [level] {
      mutate {
        add_tag => [ "level-%{level}" ]
      }
    }
    
    # Enhance field untuk better searching
    if [traceId] and [traceId] != "" {
      mutate {
        add_field => { "has_trace" => "true" }
      }
    }
    
    # Convert level to lowercase untuk consistency
    if [level] {
      mutate {
        lowercase => [ "level" ]
      }
    }
  }
}

output {
  # Kirim ke Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-perpustakaan-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][fingerprint]}"
  }
  
  # Output ke console untuk debugging (optional, bisa di-comment jika tidak perlu)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
}
